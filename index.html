<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>decode luke</title>
    </head>
    <body>
        <div>
            <textarea name="coded" id="coded" cols="200" style="height: 200px; width: 100%;"></textarea>
        </div>
        <div>
            <textarea name="decoded" id="decoded" style="height: 200px; width: 100%;">
happy birthday
be glorious
and good things will haen

the 
key 
i in the 
keyboard

enjoy

</textarea>
        </div>
        <script>
            var rows = [
                "`1234567890-=".split(""),
                "qwertyuiop[]".split(""),
                "asdfghjkl;'#".split(""),
                "\\zxcvbnm,./".split("")
            ];

            //coded.onchange = function() {
            //    decoded.value = decode(coded.value);
            //};

            //decoded.onchange = function() {
            //    coded.value = code(decoded.value);
            //};

            //decoded.onchange();
            //coded.onchange();
            coded.value = code(decoded.value);
            console.log(decode(coded.value));

            function code(original) {

                function tryUpdateShift() {
                    for (; ;) {
                        updateShift();
                        if (shiftIndex >= -3 && shiftIndex <= 3) {
                            console.log("Updated shift. shiftIndex: %i, shift: %s", shiftIndex, shift);
                            break;
                        }
                    }
                }

                var debug = [
                    ["..", 2],
                    [",", -1],
                    ["...", 3],
                    [",,,.", -2],
                    [",,..", 0],
                    [",,", -2],
                    ["..", 2],
                    [",", -1]
                ];
                var ui = 0;
                function updateShift() {
                    shift = debug[ui][0]
                    shiftIndex = debug[ui][1]
                    ui++

                    //shift = "";
                    //shiftIndex = 0;
                    //var shiftLength = (Math.random() * 6 | 0)+1;
                    //for (var i = 0; i < shiftLength; i++) {
                    //    var shiftChar = possibleShiftChars[Math.random() * 2 | 0];
                    //    shift += shiftChar;
                    //    shiftIndex += (-(45 - ".".charCodeAt())); // super readable!
                    //}
                }
                
                original = original.trim();
                var possibleShiftChars = ",.";
                var shift = "";
                var shiftIndex = 0;
                debugger;
                var output = "";
                var lines = original.split("\n");
                
                restart_line:
                for (var l = 0; l < lines.length; l++) {
                    var line = lines[l];
                    if (!line || !line.trim()) continue;
                    if (!line.trim()) {
                        output += "\n";
                        continue;
                    }

                    var lineOutput = "";
                    tryUpdateShift();
                    lineOutput += (shift + " ");
                    for (var i = 0, ch = line[i]; i < line.length; ch = line[++i]) {
                        if (ch == " ") {
                            lineOutput += ch;
                        }  else {
                            var outputChar = shiftChar(ch, shiftIndex);
                            if (typeof outputChar == "undefined") {
                                debugger
                                l--;
                                continue restart_line;
                            }
                            var reversed = shiftChar(outputChar, -shiftIndex);
                            if (typeof reversed == "undefined") {
                                debugger
                                l--;
                                continue restart_line;
                            }
                            if (ch != reversed) {
                                debugger
                                l--;
                                continue restart_line;
                            }
                            lineOutput += outputChar;
                            lineOutput += "_";
                        }
                    }
                    


                    output += (lineOutput + "\n");
                }

                return output;
            }

            function decode(source) {
                source = source.trim();
                var output = "";
                var READ_SHIFT = "READ_SHIFT";
                var READ_CODE = "READ_CODE";
                var shift = 0;
                var mode = READ_SHIFT;
                for (var i = 0; i < source.length; i++) {
                    var ch = source[i];
                    var nextChar = source[i + 1];
                    switch (mode) {
                    case READ_SHIFT:
                        if (ch == ",") {
                            shift++;
                            break;
                        } else if (ch == ".") {
                            shift--;
                            break;
                        } else {
                            mode = READ_CODE;
                        }
                    case READ_CODE:
                        if (ch == "_") continue;
                        else if (ch == "\n" && (nextChar == "," || nextChar == ".")) {
                            output += "\n";
                            mode = READ_SHIFT;
                            shift = 0;
                        } else if (ch == "\n") output += "\n";
                        else if (/\s/.test(ch)) output += " ";
                        else output += shiftChar(ch, shift);

                        break;
                    default:
                    }
                }

                return output;
            }

            function shiftChar(ch, shift) {
                ch = ch.toLowerCase();
                for (var i = 0; i < rows.length; i++) {
                    var row = rows[i];
                    for (var j = 0; j < row.length; j++) {
                        if (row[j] == ch) {
                            return row[j + shift];
                        }
                    }
                }

                return "?";
            }

        </script>
    </body>
</html>