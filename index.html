<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>decode luke</title>
    </head>
    <body>
        <div>
            <textarea name="coded" id="coded" cols="200" style="height: 200px; width: 100%;"></textarea>
        </div>
        <div>
            <textarea name="decoded" id="decoded" style="height: 200px; width: 100%;">
happy birthday
be glorious
and good things will haen

the 
key 
i in the 
keyboard

enjoy

</textarea>
        </div>
        <script>
            var rows = [
                "`1234567890-=".split(""),
                "qwertyuiop[]".split(""),
                "asdfghjkl;'#".split(""),
                "\\zxcvbnm,./".split("")
            ];

            //coded.onchange = function() {
            //    decoded.value = decode(coded.value);
            //};

            //decoded.onchange = function() {
            //    coded.value = code(decoded.value);
            //};

            //decoded.onchange();
            //coded.onchange();
            coded.value = code(decoded.value);
            console.log(decode(coded.value));

            function code(original) {

                function tryUpdateShift() {
                    for (; ;) {
                        updateShift();
                        if (shiftIndex >= -3 && shiftIndex <= 3) {
                            console.log("Updated shift. shiftIndex: %i, shift: %s", shiftIndex, shift);
                            break;
                        }
                    }
                }
                
                function updateShift() {
                    shift = "";
                    shiftIndex = 0;
                    var shiftLength = (Math.random() * 6 | 0)+1;
                    for (var i = 0; i < shiftLength; i++) {
                        var shiftChar = possibleShiftChars[Math.random() * 2 | 0];
                        shift += shiftChar;
                        shiftIndex += (-(45 - ".".charCodeAt())); // super readable!
                    }
                }
                
                original = original.trim();
                var possibleShiftChars = ",.";
                var shift = "";
                var shiftIndex = 0;
                debugger;
                var WRITE_SHIFT = "WRITE_SHIFT";
                var WRITE = "WRITE";
                var mode = WRITE_SHIFT;
                var output = "";
                for (var i = 0, char = original[i]; i < original.length; char = original[++i]) {
                    var nextChar = original[i + 1];
                    switch (mode) {
                    case WRITE_SHIFT:
                        tryUpdateShift();
                        output += (shift + " ");
                        mode = WRITE;
                        case WRITE:
                            if (/\s\s/.test(char + nextChar)) {
                                output += char;
                            }
                            else if (char == "\n") {
                                mode = WRITE_SHIFT;
                                output += "\n";
                            } else if (char == " "){
                                output += " ";
                            }else {
                                output += shiftChar(char, shiftIndex);
                                output += "_";
                            }
                            break;
                    default:
                    }
                }

                return output;
            }

            function decode(source) {
                source = source.trim();
                var output = "";
                var READ_SHIFT = "READ_SHIFT";
                var READ_CODE = "READ_CODE";
                var shift = 0;
                var mode = READ_SHIFT;
                for (var i = 0; i < source.length; i++) {
                    var char = source[i];
                    var nextChar = source[i + 1];
                    switch (mode) {
                    case READ_SHIFT:
                        if (char == ",") {
                            shift++;
                            break;
                        } else if (char == ".") {
                            shift--;
                            break;
                        } else {
                            mode = READ_CODE;
                        }
                    case READ_CODE:
                        if (char == "_") continue;
                        else if (char == "\n" && (nextChar == "," || nextChar == ".")) {
                            output += "\n";
                            mode = READ_SHIFT;
                            shift = 0;
                        } else if (char == "\n") output += "\n";
                        else if (/\s/.test(char)) output += " ";
                        else output += shiftChar(char, shift);

                        break;
                    default:
                    }
                }

                return output;
            }

            function shiftChar(char, shift) {
                char = char.toLowerCase();
                for (var i = 0; i < rows.length; i++) {
                    var row = rows[i];
                    for (var j = 0; j < row.length; j++) {
                        if (row[j] == char) {
                            return row[j + shift];
                        }
                    }
                }

                return "?";
            }

        </script>
    </body>
</html>